<!DOCTYPE html>
<html lang="de">
<head>
    {# Metadaten und Titel f√ºr die Forstbetrieb-Webseite #}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Forstbetrieb{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'MiniStore-1.0.0/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'MiniStore-1.0.0/style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
    {# Kopfzeile mit Logo, Titel und Navigationsmen√º #}
    <header class="bg-light py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-auto">
                    <img src="{% static 'images/logo3.webp' %}" alt="Forstbetrieb Logo" class="img-fluid" style="max-height: 50px;">
                </div>
                <div class="col">
                    <h1 class="mb-0">Forstbetrieb Knoop</h1>
                </div>
                <div class="col-auto">
                    {# Navigationsmen√º #}
                    <nav class="navbar navbar-expand-lg navbar-light">
                        <ul class="navbar-nav ms-auto">
                            <li class="nav-item"><a class="nav-link" href="#">Karte</a></li>
                            <li class="nav-item"><a class="nav-link" href="#">Werkzeuge</a></li>
                            <li class="nav-item"><a class="nav-link" href="#">Aufgaben</a></li>
                            <li class="nav-item"><a class="nav-link" href="#">Verwaltung</a></li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="revierDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Revier
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="revierDropdown">
                                    <li><a class="dropdown-item" href="#" data-region="kolkwitz">Kolkwitz</a></li>
                                    <li><a class="dropdown-item" href="#" data-region="rohlsdorf">Rohlsdorf</a></li>
                                </ul>
                            </li>
                            {% if user.is_authenticated %}
                                <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}">Abmelden</a></li>
                            {% else %}
                                <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Anmelden</a></li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    {# Hauptinhalt der Seite #}
    <main class="container-fluid">
        {% block content %}
        <div class="row">
            {# Kartenbereich #}
            <div class="col-9 p-0" id="map-container">
                <form id="region-form" class="mb-3">
                    <select name="region" id="region-select" class="form-select">
                        <option value="kolkwitz">Kolkwitz</option>
                        <option value="rohlsdorf">Rohlsdorf</option>
                    </select>
                </form>
                <div id="map">
                    {{ map_html|safe }}
                </div>
                {# Kartenmen√º #}
                <div id="map-menu" style="position: absolute; bottom: 10px; left: 10px; z-index: 1000;">
                    <button id="base-map-btn" class="btn btn-sm btn-light">Basiskarte</button>
                    <button id="tree-habitat-btn" class="btn btn-sm btn-light">üå≥ Baumhabitate</button>
                    <button id="placeholder-btn" class="btn btn-sm btn-light">Platzhalter</button>
                </div>
            </div>
            {# Wetterinformationen #}
            <div class="col-3 bg-light p-3" id="weather-infobar">
                <h4>Wetterinformationen</h4>
                <div id="weather-data">
                    <!-- Wetterdaten werden hier eingef√ºgt -->
                </div>
            </div>
        </div>
        {% endblock %}
    </main>

    {# Fu√üzeile #}
    <footer>
        <!-- Fu√üzeileninhalt kommt hier -->
    </footer>

    <script src="{% static 'MiniStore-1.0.0/js/bootstrap.bundle.min.js' %}"></script>
    <script>
        async function fetchWeatherData(city = 'Berlin') {
            try {
                const response = await fetch(`/weather/?city=${encodeURIComponent(city)}`);
                if (!response.ok) {
                    throw new Error('Weather data not available');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching weather data:', error);
                return null;
            }
        }

        function updateWeatherInfo(weatherData) {
            const weatherDataElement = document.getElementById('weather-data');
            if (weatherData) {
                weatherDataElement.innerHTML = `
                    <p>City: ${weatherData.city}</p>
                    <p>Temperature: ${weatherData.temperature}¬∞C</p>
                    <p>Description: ${weatherData.description}</p>
                    <img src="http://openweathermap.org/img/w/${weatherData.icon}.png" alt="Weather icon">
                `;
            } else {
                weatherDataElement.innerHTML = '<p>Weather information unavailable</p>';
            }
        }

        async function loadWeatherData(city) {
            const weatherData = await fetchWeatherData(city);
            updateWeatherInfo(weatherData);
        }

        let map;
        let baseLayer;
        let treeHabitatLayer;
        let currentRegion = 'kolkwitz';

        document.addEventListener('DOMContentLoaded', () => {
            loadWeatherData();

            // Initialize the map
            map = L.map('map').setView([51.165691, 10.451526], 6); // Center of Germany
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            const dropdownItems = document.querySelectorAll('.dropdown-item[data-region]');
            dropdownItems.forEach(item => {
                item.addEventListener('click', (event) => {
                    event.preventDefault();
                    const region = event.target.dataset.region;
                    document.getElementById('region-select').value = region;
                    updateMap(region);
                });
            });

            document.getElementById('region-select').addEventListener('change', (event) => {
                updateMap(event.target.value);
            });

            // Add event listeners for map menu buttons
            document.getElementById('base-map-btn').addEventListener('click', () => toggleLayer('base'));
            document.getElementById('tree-habitat-btn').addEventListener('click', () => toggleLayer('treeHabitat'));

            // Initial map update
            updateMap('kolkwitz');
        });

        function updateMap(region) {
            currentRegion = region;
            fetch(`/update_map/?region=${region}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Received GeoJSON data:', data.geojson);
                    if (!data.geojson) {
                        console.error('No GeoJSON data received');
                        return;
                    }
                    if (baseLayer) {
                        map.removeLayer(baseLayer);
                    }
                    baseLayer = L.geoJSON(data.geojson).addTo(map);
                    map.fitBounds(baseLayer.getBounds());

                    // Remove tree habitat layer if it exists
                    if (treeHabitatLayer) {
                        map.removeLayer(treeHabitatLayer);
                        treeHabitatLayer = null;
                    }
                })
                .catch(error => console.error('Error updating map:', error));
        }

        function toggleLayer(layerType) {
            if (layerType === 'base') {
                if (map.hasLayer(baseLayer)) {
                    map.removeLayer(baseLayer);
                } else {
                    map.addLayer(baseLayer);
                }
            } else if (layerType === 'treeHabitat') {
                if (treeHabitatLayer) {
                    map.removeLayer(treeHabitatLayer);
                    treeHabitatLayer = null;
                } else {
                    fetch(`/update_map/?region=${currentRegion}&layer=habitat`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.geojson) {
                                treeHabitatLayer = L.geoJSON(data.geojson).addTo(map);
                            }
                        })
                        .catch(error => console.error('Error loading tree habitat layer:', error));
                }
            }
        }
    </script>
</body>
</html>
